<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>50/40/10 Offer Calculator (Standalone)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- All functionality is implemented with vanilla JS so the app works fully offline inside Tauri. -->
  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --muted: #64748b;
      --text: #0f172a;
      --accent: #0ea5e9; /* sky-500 */
      --accent-2: #34d399; /* emerald-400 */
      --accent-3: #f59e0b; /* amber-500 */
      --accent-4: #ef4444; /* red-500 */
      --ring: rgba(14, 165, 233, .35);
      --radius: 14px;
    }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 16px/1.35 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    }
    .wrap {
      min-height: 100%;
      display: grid;
      grid-template-columns: minmax(0, 1fr);
    }
    header {
      padding: 24px 16px 8px;
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
    }
    h1 { font-size: clamp(22px, 3vw, 30px); margin: 0 0 6px; }
    .muted { color: var(--muted); }

    .container {
      max-width: 1200px;
      width: 100%;
      margin: 0 auto 56px;
      padding: 12px 16px 24px;
      display: grid;
      gap: 16px;
    }

    .grid {
      display: grid;
      gap: 16px;
    }
    .grid.cols-2 { grid-template-columns: repeat(1, minmax(0,1fr)); }
    @media (min-width: 1000px) {
      .grid.cols-2 { grid-template-columns: 1.1fr .9fr; }
    }

    .cards { display: grid; gap: 12px; grid-template-columns: repeat(1, minmax(0, 1fr)); }
    @media (min-width: 800px) {
      .cards { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: 0 1px 0 rgba(0,0,0,.06), 0 12px 30px -12px rgba(0,0,0,.12);
      border: 1px solid rgba(2,6,23,.06);
    }
    .card .content { padding: 16px; }
    .title-sm { font-size: 12px; color: var(--muted); }
    .big { font-size: 28px; font-weight: 700; }

    /* Controls */
    .control { display: grid; gap: 8px; }
    .row { display:flex; gap:10px; align-items:center; justify-content:space-between; }
    label { font-size: 14px; color: var(--muted); }
    input[type="number"],
    select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(15,23,42,.15);
      background: #fff;
      font-size: 14px;
      outline: none;
    }
    input[type="number"]:focus,
    select:focus { box-shadow: 0 0 0 4px var(--ring); border-color: var(--accent); }
    .field { display:grid; gap:6px; }
    .two-col { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .three-col { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    .btn {
      appearance:none; border:1px solid rgba(15,23,42,.15);
      background:#fff; color:#0f172a; padding:8px 10px; border-radius:10px; font-size:12px; cursor:pointer;
    }
    .btn:hover { border-color: var(--accent); box-shadow:0 0 0 3px var(--ring); }
    .pill {
      background: #f1f5f9; color:#0f172a; padding:8px 10px; border-radius: 999px; font-size:12px;
      border:1px solid rgba(2,6,23,.06);
    }

    /* Sliders */
    input[type="range"] {
      -webkit-appearance: none; appearance: none; width: 100%; height: 6px;
      background: #e2e8f0; border-radius: 999px; outline: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%;
      background: #fff; border:1px solid rgba(15,23,42,.15);
      box-shadow: 0 1px 0 rgba(0,0,0,.05);
      cursor: pointer;
    }
    input[type="range"]::-moz-range-thumb {
      width: 18px; height: 18px; border-radius: 50%; background: #fff; border:1px solid rgba(15,23,42,.15);
      cursor: pointer;
    }

    .charts { display: grid; gap: 16px; grid-template-columns: 1fr; }
    @media (min-width: 1000px) { .charts { grid-template-columns: 1fr 1fr; } }

    canvas { width:100%; height:360px; display:block; }

    .legend {
      display:flex;
      flex-wrap:wrap;
      gap:8px 14px;
      margin-top:12px;
      font-size:12px;
      color:var(--muted);
    }
    .legend span {
      display:flex;
      align-items:center;
      gap:6px;
    }
    .legend span i {
      display:inline-block;
      width:12px;
      height:12px;
      border-radius:3px;
      background:var(--accent);
      box-shadow:0 0 0 1px rgba(15,23,42,.12);
    }

    .note { font-size:12px; color:var(--muted); }

    h2 { font-size: clamp(20px, 2.6vw, 26px); margin: 32px 0 8px; }
    #dealAnalyzer { margin-bottom: 64px; }
    .stat-list { display:grid; gap:8px; margin:12px 0 0; padding:0; list-style:none; }
    .stat { display:flex; justify-content:space-between; align-items:center; gap:12px; padding:6px 0; border-bottom:1px solid rgba(2,6,23,.08); font-size:14px; }
    .stat:last-child { border-bottom:none; }
    .stat .label { color:var(--muted); }
    .stat .value { font-weight:600; }
    .unit-field .btn { font-size:11px; }
    .unit-field .row { align-items:center; }
    .section-note { font-size:12px; color:var(--muted); margin-top:-4px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>50/40/10 Real Estate Offer Calculator</h1>
      <div class="muted">Smooth sliders, minimal dependencies, runs locally. Dallas tax snap included.</div>
    </header>

    <main class="container">
      <!-- Top KPIs -->
      <div class="cards">
        <div class="card"><div class="content"><div class="title-sm">Total Monthly (50/40/10 PITI)</div><div id="kpiPITI" class="big">$—</div></div></div>
        <div class="card"><div class="content"><div class="title-sm">Cash to Close (50/40/10)</div><div id="kpiCash" class="big">$—</div></div></div>
        <div class="card"><div class="content"><div class="title-sm">PITI (Conventional)</div><div id="kpiConvPITI" class="big">$—</div></div></div>
        <div class="card"><div class="content"><div class="title-sm">Cash to Close (Conventional)</div><div id="kpiConvCash" class="big">$—</div></div></div>
      </div>

      <div class="grid cols-2">
        <!-- Inputs -->
        <div class="card">
          <div class="content">
            <div class="grid" style="gap:14px">
              <div class="field">
                <label>Property Price</label>
                <div class="two-col">
                  <input id="price" type="number" min="0" step="1000" value="500000" />
                  <span class="pill" id="pricePretty">$500,000</span>
                </div>
              </div>

              <div class="field">
                <div class="row">
                  <label>Property Tax Rate (%/yr)</label>
                  <button class="btn" id="btnDallas">Dallas 2.23503%</button>
                </div>
                <div class="two-col">
                  <input id="taxRate" type="number" min="0" step="0.00001" value="2.23503" />
                  <span class="pill" id="taxMonthly">$— /mo</span>
                </div>
              </div>

              <div class="field">
                <label>Insurance (annual $)</label>
                <div class="two-col">
                  <input id="insAnnual" type="number" min="0" step="100" />
                  <span class="pill" id="insMonthly">$— /mo</span>
                </div>
                <div class="note">Defaults to 0.8% of property price.</div>
              </div>

              <div class="field">
                <label>Closing Costs (% of price, 50/40/10)</label>
                <div class="two-col">
                  <input id="closingPct" type="number" min="0" max="20" step="0.1" value="2.5" />
                  <span class="pill" id="closingCash">$—</span>
                </div>
              </div>

              <div class="field">
                <div class="row"><label>Loan Structure (50/40/10)</label><span class="note">1st + 2nd ≤ 100%</span></div>
                <div class="three-col">
                  <div class="field">
                    <div class="row"><span class="note">1st %</span><span class="note" id="firstPctLabel">50%</span></div>
                    <input id="firstPct" type="range" min="0" max="100" step="0.1" value="50" />
                    <input id="firstPctNum" type="number" min="0" max="100" step="0.1" value="50" />
                    <div class="note" id="firstAmtLabel">$—</div>
                  </div>
                  <div class="field">
                    <div class="row"><span class="note">2nd %</span><span class="note" id="secondPctLabel">40%</span></div>
                    <input id="secondPct" type="range" min="0" max="100" step="0.1" value="40" />
                    <input id="secondPctNum" type="number" min="0" max="100" step="0.1" value="40" />
                    <div class="note" id="secondAmtLabel">$—</div>
                  </div>
                  <div class="field">
                    <div class="note">Down %</div>
                    <div class="pill" id="downPctPill">10% = $—</div>
                    <div class="note">Auto = 100 − (1st + 2nd)</div>
                  </div>
                </div>
              </div>

              <div class="two-col">
                <div class="field">
                  <label>1st Rate %</label>
                  <input id="firstRate" type="number" min="0" max="30" step="0.01" value="7.25" />
                </div>
                <div class="field">
                  <label>1st Term (years)</label>
                  <input id="firstTerm" type="number" min="1" max="40" step="1" value="30" />
                </div>
              </div>

              <div class="two-col">
                <div class="field">
                  <label>2nd Rate %</label>
                  <input id="secondRate" type="number" min="0" max="30" step="0.01" value="5.5" />
                </div>
                <div class="field">
                  <label>2nd Term (years)</label>
                  <input id="secondTerm" type="number" min="1" max="40" step="1" value="30" />
                </div>
              </div>

              <div class="two-col">
                <div class="field">
                  <label>Interest-only 2nd?</label>
                  <input id="secondIO" type="checkbox" />
                </div>
                <div class="field">
                  <label>Balloon (years, 0 = none)</label>
                  <input id="balloonYears" type="number" min="0" max="40" step="1" value="0" />
                </div>
              </div>

              <div class="card"><div class="content">
                <div class="title-sm">Conventional (Comparison)</div>
                <div class="two-col" style="margin-top:8px">
                  <div class="field"><label>Down %</label><input id="convDown" type="number" min="0" max="100" step="0.1" value="20" /></div>
                  <div class="field"><label>Rate %</label><input id="convRate" type="number" min="0" max="30" step="0.01" value="7.25" /></div>
                </div>
                <div class="two-col" style="margin-top:8px">
                  <div class="field"><label>Term (yrs)</label><input id="convTerm" type="number" min="1" max="40" step="1" value="30" /></div>
                  <div class="field"><label>Closing %</label><input id="convClose" type="number" min="0" max="20" step="0.1" value="2.5" /></div>
                </div>
              </div></div>

            </div>
          </div>
        </div>

        <!-- Charts & Breakdown -->
        <div class="grid">
          <div class="card">
            <div class="content">
              <div class="title-sm" style="margin-bottom:8px">Payment Breakdown (50/40/10)</div>
              <div class="two-col" style="gap:8px;margin-bottom:10px">
                <span class="pill">1st (P&I): <strong id="pill1">$—</strong></span>
                <span class="pill">2nd: <strong id="pill2">$—</strong></span>
              </div>
              <div class="two-col" style="gap:8px;margin-bottom:10px">
                <span class="pill">Taxes: <strong id="pillTax">$—</strong></span>
                <span class="pill">Insurance: <strong id="pillIns">$—</strong></span>
              </div>
              <canvas id="pie"></canvas>
              <div class="legend" id="pieLegend"></div>
              <div class="note" style="margin-top:8px">Total Monthly (PITI): <strong id="totalPITI">$—</strong></div>
            </div>
          </div>

          <div class="card">
            <div class="content">
              <div class="title-sm" style="margin-bottom:8px">50/40/10 vs Conventional (Stacked PITI)</div>
              <canvas id="bar"></canvas>
              <div class="legend" id="barLegend"></div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <section class="container" id="dealAnalyzer">
      <h2>Quick Deal Analyzer</h2>
      <div class="section-note">Plug in rents, expenses, and financing terms to get an instant read on cash flow and returns.</div>

      <div class="cards">
        <div class="card"><div class="content"><div class="title-sm">Total Cash Needed</div><div id="anCashNeededKpi" class="big">$—</div></div></div>
        <div class="card"><div class="content"><div class="title-sm">Gross Monthly Rent</div><div id="anGrossRentKpi" class="big">$—</div></div></div>
        <div class="card"><div class="content"><div class="title-sm">Monthly Cash Flow</div><div id="anCashflowKpi" class="big">$—</div></div></div>
        <div class="card"><div class="content"><div class="title-sm">Cash-on-Cash Return</div><div id="anCocKpi" class="big">—</div></div></div>
      </div>

      <div class="grid cols-2">
        <div class="card">
          <div class="content">
            <div class="grid" style="gap:14px">
              <div class="field">
                <label>Purchase Price</label>
                <div class="two-col">
                  <input id="anPrice" type="number" min="0" step="1000" value="350000" />
                  <span class="pill" id="anPricePretty">$—</span>
                </div>
              </div>

              <div class="field">
                <label>Square Footage</label>
                <input id="anSqft" type="number" min="0" step="10" value="1800" />
              </div>

              <div class="field">
                <div class="row">
                  <label>Rehab Budget</label>
                  <span class="pill" id="anRehabDisplay">$—</span>
                </div>
                <div class="two-col">
                  <select id="rehabMode">
                    <option value="total">Total Cost</option>
                    <option value="perSqft">Cost per Sq Ft</option>
                  </select>
                  <input id="rehabValue" type="number" min="0" step="500" value="30000" />
                </div>
                <div class="note">Switch between total rehab dollars or per-square-foot budgeting.</div>
              </div>

              <div class="two-col">
                <div class="field">
                  <label>Closing Costs (% of price)</label>
                  <input id="anClosingPct" type="number" min="0" max="20" step="0.1" value="3" />
                </div>
                <div class="field">
                  <label>Down Payment %</label>
                  <input id="anDownPct" type="number" min="0" max="100" step="0.1" value="20" />
                </div>
              </div>

              <div class="field unit-field">
                <div class="row">
                  <label>Units &amp; Monthly Rent</label>
                  <button type="button" class="btn" id="addUnitBtn">Add Unit</button>
                </div>
                <div id="unitsList" class="grid" style="gap:12px"></div>
              </div>

              <div class="two-col">
                <div class="field">
                  <label>Monthly Operating Expenses</label>
                  <input id="anMonthlyExpenses" type="number" min="0" step="50" value="450" />
                </div>
                <div class="field">
                  <label>Monthly Utilities</label>
                  <input id="anUtilities" type="number" min="0" step="50" value="150" />
                </div>
              </div>

              <div class="two-col">
                <div class="field">
                  <label>Management Fee % of Rent</label>
                  <input id="anMgmtPct" type="number" min="0" max="30" step="0.1" value="8" />
                </div>
                <div class="field">
                  <label>Other Monthly Income</label>
                  <input id="anOtherIncome" type="number" min="0" step="25" value="0" />
                </div>
              </div>

              <div class="two-col">
                <div class="field">
                  <label>Annual Taxes</label>
                  <input id="anTaxesAnnual" type="number" min="0" step="100" value="5200" />
                </div>
                <div class="field">
                  <label>Annual Insurance</label>
                  <input id="anInsAnnual" type="number" min="0" step="100" value="1800" />
                </div>
              </div>

              <div class="two-col">
                <div class="field">
                  <label>Other Annual Expenses</label>
                  <input id="anOtherAnnual" type="number" min="0" step="100" value="600" />
                </div>
                <div class="field">
                  <label>Vacancy Allowance %</label>
                  <input id="anVacancyPct" type="number" min="0" max="100" step="0.5" value="5" />
                </div>
              </div>

              <div class="two-col">
                <div class="field">
                  <label>Interest Rate %</label>
                  <input id="anRate" type="number" min="0" max="30" step="0.01" value="6.75" />
                </div>
                <div class="field">
                  <label>Amortization (years)</label>
                  <input id="anAmortYears" type="number" min="1" max="40" step="1" value="30" />
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="grid">
          <div class="card">
            <div class="content">
              <div class="title-sm" style="margin-bottom:8px">Deal Snapshot</div>
              <div class="stat-list">
                <div class="stat"><span class="label">Purchase Price</span><span class="value" id="anPriceLabel">$—</span></div>
                <div class="stat"><span class="label">Rehab Budget</span><span class="value" id="anRehabLabel">$—</span></div>
                <div class="stat"><span class="label">Closing Costs</span><span class="value" id="anClosingLabel">$—</span></div>
                <div class="stat"><span class="label">Total Project Cost</span><span class="value" id="anProjectCost">$—</span></div>
                <div class="stat"><span class="label">Total Cash Needed</span><span class="value" id="anCashNeeded">$—</span></div>
                <div class="stat"><span class="label">Loan Amount</span><span class="value" id="anLoanAmount">$—</span></div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="content">
              <div class="title-sm" style="margin-bottom:8px">Income &amp; Expense Breakdown</div>
              <div class="stat-list">
                <div class="stat"><span class="label">Gross Monthly Rent</span><span class="value" id="anGrossRent">$—</span></div>
                <div class="stat"><span class="label">Other Monthly Income</span><span class="value" id="anOtherIncomeLabel">$—</span></div>
                <div class="stat"><span class="label">Vacancy Loss</span><span class="value" id="anVacancyLoss">$—</span></div>
                <div class="stat"><span class="label">Effective Monthly Income</span><span class="value" id="anEffectiveIncome">$—</span></div>
                <div class="stat"><span class="label">Management Fee</span><span class="value" id="anMgmtFee">$—</span></div>
                <div class="stat"><span class="label">Monthly Operating Expenses</span><span class="value" id="anOpExMonthly">$—</span></div>
                <div class="stat"><span class="label">Monthly NOI</span><span class="value" id="anNoiMonthly">$—</span></div>
                <div class="stat"><span class="label">Annual NOI</span><span class="value" id="anNoiAnnual">$—</span></div>
                <div class="stat"><span class="label">Monthly Mortgage</span><span class="value" id="anMortgage">$—</span></div>
                <div class="stat"><span class="label">Monthly Cash Flow</span><span class="value" id="anCashflow">$—</span></div>
                <div class="stat"><span class="label">Cap Rate</span><span class="value" id="anCapRate">—</span></div>
                <div class="stat"><span class="label">Cash-on-Cash Return</span><span class="value" id="anCoc">—</span></div>
                <div class="stat"><span class="label">DSCR</span><span class="value" id="anDscr">—</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

<script>
  // --- Helpers ---
  const $ = (id) => document.getElementById(id);
  const fmt = (n) => isFinite(n) ? n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0}) : "—";
  const fmtPct = (n) => isFinite(n) ? `${n.toFixed(2)}%` : "—";
  const clamp = (n,min,max) => Math.min(max, Math.max(min,n));

  function monthlyPayment(principal, annualRatePct, termYears) {
    const r = (annualRatePct/100) / 12;
    const n = Math.max(1, Math.round(termYears*12));
    if (r === 0) return principal / n;
    return principal * (r * Math.pow(1+r,n)) / (Math.pow(1+r,n)-1);
  }

  // --- Inputs ---
  const price = $("price");
  const taxRate = $("taxRate");
  const insAnnual = $("insAnnual");
  const closingPct = $("closingPct");
  const firstPct = $("firstPct");
  const firstPctNum = $("firstPctNum");
  const secondPct = $("secondPct");
  const secondPctNum = $("secondPctNum");
  const firstRate = $("firstRate");
  const firstTerm = $("firstTerm");
  const secondRate = $("secondRate");
  const secondTerm = $("secondTerm");
  const secondIO = $("secondIO");
  const balloonYears = $("balloonYears");
  const convDown = $("convDown");
  const convRate = $("convRate");
  const convTerm = $("convTerm");
  const convClose = $("convClose");

  // labels
  const pricePretty = $("pricePretty");
  const taxMonthly = $("taxMonthly");
  const insMonthly = $("insMonthly");
  const closingCash = $("closingCash");
  const firstPctLabel = $("firstPctLabel");
  const secondPctLabel = $("secondPctLabel");
  const firstAmtLabel = $("firstAmtLabel");
  const secondAmtLabel = $("secondAmtLabel");
  const downPctPill = $("downPctPill");
  const pill1 = $("pill1");
  const pill2 = $("pill2");
  const pillTax = $("pillTax");
  const pillIns = $("pillIns");
  const totalPITI = $("totalPITI");

  const kpiPITI = $("kpiPITI");
  const kpiCash = $("kpiCash");
  const kpiConvPITI = $("kpiConvPITI");
  const kpiConvCash = $("kpiConvCash");

  // Deal analyzer inputs
  const anPrice = $("anPrice");
  const anSqft = $("anSqft");
  const rehabMode = $("rehabMode");
  const rehabValue = $("rehabValue");
  const anClosingPct = $("anClosingPct");
  const anDownPct = $("anDownPct");
  const unitsList = $("unitsList");
  const addUnitBtn = $("addUnitBtn");
  const anMonthlyExpenses = $("anMonthlyExpenses");
  const anUtilities = $("anUtilities");
  const anMgmtPct = $("anMgmtPct");
  const anOtherIncomeInput = $("anOtherIncome");
  const anTaxesAnnual = $("anTaxesAnnual");
  const anInsAnnual = $("anInsAnnual");
  const anOtherAnnual = $("anOtherAnnual");
  const anVacancyPct = $("anVacancyPct");
  const anRate = $("anRate");
  const anAmortYears = $("anAmortYears");

  // Deal analyzer labels
  const anPricePretty = $("anPricePretty");
  const anRehabDisplay = $("anRehabDisplay");
  const anCashNeededKpi = $("anCashNeededKpi");
  const anGrossRentKpi = $("anGrossRentKpi");
  const anCashflowKpi = $("anCashflowKpi");
  const anCocKpi = $("anCocKpi");

  const anPriceLabel = $("anPriceLabel");
  const anRehabLabel = $("anRehabLabel");
  const anClosingLabel = $("anClosingLabel");
  const anProjectCost = $("anProjectCost");
  const anCashNeeded = $("anCashNeeded");
  const anLoanAmount = $("anLoanAmount");
  const anGrossRent = $("anGrossRent");
  const anOtherIncomeLabel = $("anOtherIncomeLabel");
  const anVacancyLoss = $("anVacancyLoss");
  const anEffectiveIncome = $("anEffectiveIncome");
  const anMgmtFeeLabel = $("anMgmtFee");
  const anOpExMonthly = $("anOpExMonthly");
  const anNoiMonthly = $("anNoiMonthly");
  const anNoiAnnual = $("anNoiAnnual");
  const anMortgage = $("anMortgage");
  const anCashflow = $("anCashflow");
  const anCapRate = $("anCapRate");
  const anCoc = $("anCoc");
  const anDscr = $("anDscr");

  // Dallas snap
  $("btnDallas").addEventListener("click", () => { taxRate.value = "2.23503"; update(); });

  // Default insurance = 0.8% of price (set once on load and whenever price changes if user hasn't touched)
  let userSetInsurance = false;
  insAnnual.addEventListener("input", () => { userSetInsurance = true; });
  function ensureDefaultInsurance() {
    if (!userSetInsurance) insAnnual.value = Math.round(Number(price.value || 0)*0.008);
  }

  // --- Charts (vanilla canvas) ---
  const PIE_COLORS = ["#60a5fa","#34d399","#f472b6","#facc15"];
  const BAR_SERIES = [
    { label: "Mortgage (1st)", color: "#60a5fa" },
    { label: "Seller (2nd)", color: "#34d399" },
    { label: "Taxes", color: "#ef4444" },
    { label: "Insurance", color: "#f59e0b" }
  ];

  const pieCanvas = $("pie");
  const barCanvas = $("bar");
  const pieCtx = pieCanvas.getContext("2d");
  const barCtx = barCanvas.getContext("2d");
  const pieLegend = $("pieLegend");
  const barLegend = $("barLegend");

  const rootStyle = getComputedStyle(document.documentElement);
  const cardColor = rootStyle.getPropertyValue("--card").trim() || "#ffffff";
  const mutedColor = rootStyle.getPropertyValue("--muted").trim() || "#64748b";

  function ensureCanvasResolution(canvas, ctx) {
    const ratio = window.devicePixelRatio || 1;
    const width = canvas.clientWidth || 1;
    const height = canvas.clientHeight || 1;
    const scaledWidth = Math.round(width * ratio);
    const scaledHeight = Math.round(height * ratio);
    if (canvas.width !== scaledWidth || canvas.height !== scaledHeight) {
      canvas.width = scaledWidth;
      canvas.height = scaledHeight;
    }
    ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
    ctx.clearRect(0, 0, width, height);
    return { width, height };
  }

  function renderPie(values) {
    const labels = ["First (P&I)", "Second", "Taxes", "Insurance"];
    const { width, height } = ensureCanvasResolution(pieCanvas, pieCtx);
    const total = values.reduce((sum, val) => sum + val, 0);
    const centerX = width / 2;
    const centerY = height / 2;
    const radius = Math.min(width, height) / 2 - 12;
    let startAngle = -Math.PI / 2;

    if (total <= 0) {
      pieCtx.fillStyle = "#e2e8f0";
      pieCtx.beginPath();
      pieCtx.arc(centerX, centerY, radius, 0, Math.PI * 2);
      pieCtx.fill();
    } else {
      values.forEach((value, index) => {
        const angle = (value / total) * Math.PI * 2;
        if (angle <= 0) return;
        pieCtx.beginPath();
        pieCtx.moveTo(centerX, centerY);
        pieCtx.arc(centerX, centerY, radius, startAngle, startAngle + angle);
        pieCtx.closePath();
        pieCtx.fillStyle = PIE_COLORS[index];
        pieCtx.fill();
        startAngle += angle;
      });
    }

    pieCtx.beginPath();
    pieCtx.fillStyle = cardColor;
    pieCtx.arc(centerX, centerY, radius * 0.55, 0, Math.PI * 2);
    pieCtx.fill();

    pieLegend.innerHTML = labels.map((label, index) => {
      return `<span><i style="background:${PIE_COLORS[index]}"></i>${label}: <strong>${fmt(values[index])}</strong></span>`;
    }).join("");
  }

  function renderBar(groups) {
    const { width, height } = ensureCanvasResolution(barCanvas, barCtx);
    const padding = { top: 16, right: 24, bottom: 44, left: 72 };
    const chartWidth = Math.max(1, width - padding.left - padding.right);
    const chartHeight = Math.max(1, height - padding.top - padding.bottom);
    const totals = groups.map(group => group.values.reduce((sum, val) => sum + val, 0));
    const maxTotal = Math.max(...totals, 1);

    const steps = 4;
    barCtx.lineWidth = 1;
    barCtx.strokeStyle = "rgba(148, 163, 184, 0.3)";
    barCtx.fillStyle = mutedColor;
    barCtx.font = "12px system-ui";
    barCtx.textAlign = "right";
    barCtx.textBaseline = "middle";
    for (let i = 0; i <= steps; i++) {
      const y = padding.top + chartHeight - (chartHeight / steps) * i;
      barCtx.beginPath();
      barCtx.moveTo(padding.left, y);
      barCtx.lineTo(padding.left + chartWidth, y);
      barCtx.stroke();
      const value = (maxTotal / steps) * i;
      barCtx.fillText(fmt(value), padding.left - 8, y);
    }

    const spacing = chartWidth / groups.length;
    const barWidth = Math.min(80, spacing * 0.6);

    groups.forEach((group, index) => {
      const x = padding.left + spacing * index + (spacing - barWidth) / 2;
      let currentY = padding.top + chartHeight;

      BAR_SERIES.forEach((series, seriesIndex) => {
        const value = group.values[seriesIndex];
        if (!value) return;
        const heightPortion = (value / maxTotal) * chartHeight;
        if (heightPortion <= 0) return;
        barCtx.fillStyle = series.color;
        barCtx.fillRect(x, currentY - heightPortion, barWidth, heightPortion);
        currentY -= heightPortion;
      });

      barCtx.fillStyle = mutedColor;
      barCtx.textAlign = "center";
      barCtx.textBaseline = "top";
      barCtx.fillText(group.label, x + barWidth / 2, padding.top + chartHeight + 8);

      barCtx.fillStyle = "#0f172a";
      barCtx.textBaseline = "bottom";
      barCtx.fillText(fmt(totals[index]), x + barWidth / 2, currentY - 6);
    });

    barLegend.innerHTML = BAR_SERIES.map(series => `<span><i style="background:${series.color}"></i>${series.label}</span>`).join("");
  }

  function refreshUnitIndexes() {
    const fields = unitsList.querySelectorAll('.unit-field-item');
    fields.forEach((field, idx) => {
      const label = field.querySelector('.unit-label');
      if (label) label.textContent = `Unit ${idx + 1} Rent ($/mo)`;
      const removeBtn = field.querySelector('.unit-remove');
      if (removeBtn) removeBtn.disabled = fields.length === 1;
    });
  }

  function addUnitField(initialValue = 0) {
    const wrapper = document.createElement('div');
    wrapper.className = 'field unit-field-item';
    wrapper.innerHTML = `
      <div class="row">
        <label class="unit-label"></label>
        <button type="button" class="btn unit-remove">Remove</button>
      </div>
      <input type="number" class="unit-rent" min="0" step="25" value="${initialValue}" />
    `;
    const rentInput = wrapper.querySelector('.unit-rent');
    rentInput.addEventListener('input', updateAnalyzer);
    const removeBtn = wrapper.querySelector('.unit-remove');
    removeBtn.addEventListener('click', () => {
      wrapper.remove();
      refreshUnitIndexes();
      updateAnalyzer();
    });
    unitsList.appendChild(wrapper);
    refreshUnitIndexes();
  }

  // --- Logic ---
  let liveFirst = Number(firstPct.value);
  let liveSecond = Number(secondPct.value);

  function syncStructure(from) {
    // keep 1st+2nd ≤ 100 and mirror range/number pairs
    let f = clamp(Number(firstPct.value), 0, 100);
    let s = clamp(Number(secondPct.value), 0, 100);
    if (from === "first") {
      if (f + s > 100) s = 100 - f;
    } else if (from === "second") {
      if (f + s > 100) f = 100 - s;
    }
    firstPct.value = f; firstPctNum.value = f;
    secondPct.value = s; secondPctNum.value = s;
    liveFirst = f; liveSecond = s;
    firstPctLabel.textContent = f.toFixed(1) + "%";
    secondPctLabel.textContent = s.toFixed(1) + "%";
  }

  function update() {
    ensureDefaultInsurance();

    const P = Number(price.value||0);
    const taxPct = Number(taxRate.value||0);
    const annualIns = Number(insAnnual.value||0);
    const closePct = Number(closingPct.value||0);

    const fPct = Number(firstPct.value||0);
    const sPct = Number(secondPct.value||0);
    const dPct = clamp(100 - fPct - sPct, 0, 100);

    const firstAmount = P * fPct/100;
    const secondAmount = P * sPct/100;
    const downAmount = P * dPct/100;

    pricePretty.textContent = fmt(P);
    const taxMo = P * (taxPct/100)/12;
    const insMo = annualIns / 12;
    taxMonthly.textContent = fmt(taxMo) + " /mo";
    insMonthly.textContent = fmt(insMo) + " /mo";
    closingCash.textContent = fmt(P * (closePct/100));

    firstAmtLabel.textContent = fmt(firstAmount);
    secondAmtLabel.textContent = fmt(secondAmount);
    downPctPill.textContent = `${dPct.toFixed(2)}% = ${fmt(downAmount)}`;

    const firstRatePct = Number(firstRate.value||0);
    const firstYears = Number(firstTerm.value||0);
    const secondRatePct = Number(secondRate.value||0);
    const secondYears = Number(secondTerm.value||0);
    const isIO = !!secondIO.checked;

    const firstPmt = monthlyPayment(firstAmount, firstRatePct, firstYears);
    const secondPmt = isIO ? (secondAmount * (secondRatePct/100)/12) : monthlyPayment(secondAmount, secondRatePct, secondYears);
    const piti = firstPmt + secondPmt + taxMo + insMo;
    const cashToClose = P*(closePct/100) + downAmount;

    pill1.textContent = fmt(firstPmt);
    pill2.textContent = fmt(secondPmt);
    pillTax.textContent = fmt(taxMo);
    pillIns.textContent = fmt(insMo);
    totalPITI.textContent = fmt(piti);

    // KPIs
    kpiPITI.textContent = fmt(piti);
    kpiCash.textContent = fmt(cashToClose);

    // Conventional
    const convDownPct = Number(convDown.value||0);
    const convRatePct = Number(convRate.value||0);
    const convYears = Number(convTerm.value||0);
    const convClosePct = Number(convClose.value||0);
    const convDownAmt = P*convDownPct/100;
    const convLoanAmt = P - convDownAmt;
    const convPmt = monthlyPayment(convLoanAmt, convRatePct, convYears);
    const convPITI = convPmt + taxMo + insMo;
    const convCash = P*(convClosePct/100) + convDownAmt;

    kpiConvPITI.textContent = fmt(convPITI);
    kpiConvCash.textContent = fmt(convCash);

    // Charts
    renderPie([firstPmt, secondPmt, taxMo, insMo]);
    renderBar([
      { label: "50/40/10", values: [firstPmt, secondPmt, taxMo, insMo] },
      { label: "Conventional", values: [convPmt, 0, taxMo, insMo] }
    ]);
  }

  function updateAnalyzer() {
    const priceVal = Number(anPrice.value || 0);
    const sqftVal = Number(anSqft.value || 0);
    const rehabInputVal = Number(rehabValue.value || 0);
    const rehabModeVal = rehabMode.value;
    const closingPctVal = Number(anClosingPct.value || 0);
    const downPctVal = clamp(Number(anDownPct.value || 0), 0, 100);
    const monthlyExpensesVal = Number(anMonthlyExpenses.value || 0);
    const utilitiesVal = Number(anUtilities.value || 0);
    const mgmtPctVal = Math.max(0, Number(anMgmtPct.value || 0));
    const otherIncomeVal = Number(anOtherIncomeInput.value || 0);
    const taxesAnnualVal = Number(anTaxesAnnual.value || 0);
    const insAnnualVal = Number(anInsAnnual.value || 0);
    const otherAnnualVal = Number(anOtherAnnual.value || 0);
    const vacancyPctVal = clamp(Number(anVacancyPct.value || 0), 0, 100);
    const rateVal = Number(anRate.value || 0);
    const amortYearsVal = Math.max(1, Number(anAmortYears.value || 0));

    const rehabTotal = rehabModeVal === 'perSqft' ? rehabInputVal * sqftVal : rehabInputVal;
    const closingCostAmt = priceVal * (closingPctVal / 100);
    const downPaymentAmt = priceVal * (downPctVal / 100);
    const loanAmount = Math.max(0, priceVal - downPaymentAmt);

    const rents = Array.from(unitsList.querySelectorAll('.unit-rent')).map(input => Number(input.value || 0));
    const grossRent = rents.reduce((sum, val) => sum + val, 0);
    const grossMonthlyIncome = grossRent + otherIncomeVal;
    const vacancyLoss = grossMonthlyIncome * (vacancyPctVal / 100);
    const effectiveIncome = grossMonthlyIncome - vacancyLoss;

    const managementFee = effectiveIncome * (mgmtPctVal / 100);
    const baseOperatingMonthly = monthlyExpensesVal + utilitiesVal + (taxesAnnualVal / 12) + (insAnnualVal / 12) + (otherAnnualVal / 12);
    const totalOperatingMonthly = baseOperatingMonthly + managementFee;
    const noiMonthly = effectiveIncome - totalOperatingMonthly;
    const noiAnnual = noiMonthly * 12;
    const mortgagePayment = loanAmount > 0 ? monthlyPayment(loanAmount, rateVal, amortYearsVal) : 0;
    const monthlyCashflow = noiMonthly - mortgagePayment;

    const totalProjectCost = priceVal + rehabTotal;
    const totalCashNeeded = downPaymentAmt + closingCostAmt + rehabTotal;
    const capRateVal = totalProjectCost > 0 ? (noiAnnual / totalProjectCost) * 100 : NaN;
    const cashOnCashVal = totalCashNeeded > 0 ? (monthlyCashflow * 12 / totalCashNeeded) * 100 : NaN;
    const dscrVal = mortgagePayment > 0 ? noiMonthly / mortgagePayment : NaN;

    anPricePretty.textContent = fmt(priceVal);
    anRehabDisplay.textContent = fmt(rehabTotal);

    anCashNeededKpi.textContent = fmt(totalCashNeeded);
    anGrossRentKpi.textContent = fmt(grossRent);
    anCashflowKpi.textContent = fmt(monthlyCashflow);
    anCocKpi.textContent = fmtPct(cashOnCashVal);

    anPriceLabel.textContent = fmt(priceVal);
    anRehabLabel.textContent = fmt(rehabTotal);
    anClosingLabel.textContent = fmt(closingCostAmt);
    anProjectCost.textContent = fmt(totalProjectCost);
    anCashNeeded.textContent = fmt(totalCashNeeded);
    anLoanAmount.textContent = fmt(loanAmount);

    anGrossRent.textContent = fmt(grossRent);
    anOtherIncomeLabel.textContent = fmt(otherIncomeVal);
    anVacancyLoss.textContent = fmt(-vacancyLoss);
    anEffectiveIncome.textContent = fmt(effectiveIncome);
    anMgmtFeeLabel.textContent = fmt(managementFee);
    anOpExMonthly.textContent = fmt(totalOperatingMonthly);
    anNoiMonthly.textContent = fmt(noiMonthly);
    anNoiAnnual.textContent = fmt(noiAnnual);
    anMortgage.textContent = fmt(mortgagePayment);
    anCashflow.textContent = fmt(monthlyCashflow);
    anCapRate.textContent = fmtPct(capRateVal);
    anCoc.textContent = fmtPct(cashOnCashVal);
    anDscr.textContent = isFinite(dscrVal) ? dscrVal.toFixed(2) : '—';
  }

  // Live slider display: update labels immediately, compute on input (fast enough here)
  firstPct.addEventListener("input", () => { syncStructure("first"); update(); });
  secondPct.addEventListener("input", () => { syncStructure("second"); update(); });
  firstPctNum.addEventListener("input", () => { firstPct.value = firstPctNum.value; syncStructure("first"); update(); });
  secondPctNum.addEventListener("input", () => { secondPct.value = secondPctNum.value; syncStructure("second"); update(); });

  // Other fields
  [price,taxRate,insAnnual,closingPct,firstRate,firstTerm,secondRate,secondTerm,secondIO,balloonYears,convDown,convRate,convTerm,convClose]
    .forEach(el => el.addEventListener(el.type === "checkbox" ? "change" : "input", update));

  const analyzerInputs = [anPrice, anSqft, rehabMode, rehabValue, anClosingPct, anDownPct, anMonthlyExpenses, anUtilities, anMgmtPct, anOtherIncomeInput, anTaxesAnnual, anInsAnnual, anOtherAnnual, anVacancyPct, anRate, anAmortYears];
  analyzerInputs.forEach(el => {
    if (!el) return;
    const eventName = el.tagName === 'SELECT' ? 'change' : 'input';
    el.addEventListener(eventName, updateAnalyzer);
  });

  addUnitBtn.addEventListener('click', () => {
    addUnitField();
    updateAnalyzer();
  });

  // Initial
  ensureDefaultInsurance();
  update();
  addUnitField(1800);
  updateAnalyzer();
  window.addEventListener("resize", () => update());
</script>
</body>
</html>
